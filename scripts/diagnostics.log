=== TREE (depth 3) ===
.
./latest_ci_log.txt
./babbel_core
./babbel_core/cultural_shift_detector.py
./babbel_core/cleanup_review.sh
./babbel_core/_quarantine
./babbel_core/_quarantine/config.py
./babbel_core/_quarantine/context.py
./babbel_core/memory_anchor.py
./babbel_core/engine_patch.py
./babbel_core/thread.py
./babbel_core/.DS_Store
./babbel_core/_import_shim.py
./babbel_core/config.py
./babbel_core/core
./babbel_core/core/protocol_guard.py
./babbel_core/core/emotion_classifier.py
./babbel_core/core/classifier.py
./babbel_core/core/hx_engine.py
./babbel_core/core/style_engine.py
./babbel_core/core/.DS_Store
./babbel_core/core/node_rewrite_v2.py
./babbel_core/core/culture_shift.py
./babbel_core/core/__init__.py
./babbel_core/core/observability.py
./babbel_core/core/tokens.py
./babbel_core/core/memory_tracker.py
./babbel_core/core/intent_classifier.py
./babbel_core/core/review.py
./babbel_core/core/test_pipeline_run.py
./babbel_core/core/tone_constants.py
./babbel_core/core/utils.py
./babbel_core/core/pipeline.py
./babbel_core/core/orchestrator.py
./babbel_core/core/node_rules.py
./babbel_core/core/safety.py
./babbel_core/core/rewrite.py
./babbel_core/core/fallback.py
./babbel_core/core/schema.py
./babbel_core/session_state.py
./babbel_core/protocol_retry.py
./babbel_core/prompt_builder.py
./babbel_core/engine 2.py
./babbel_core/engine_memory.py
./babbel_core/test_run.py
./babbel_core/scoring.py
./babbel_core/streamlit_babbel_app.py
./babbel_core/tests
./babbel_core/tests/test_engine.py
./babbel_core/tests/test_utils.py
./babbel_core/tests/test_session_cli.py
./babbel_core/tests/test_thread_persistence.py
./babbel_core/tests/test_pop_last_exchange.py
./babbel_core/tests/test_print_tree.py
./babbel_core/tests/test_session_search.py
./babbel_core/tests/test_engine_basic.py
./babbel_core/tests/test_pipeline_smoke.py
./babbel_core/tests/test_session_metadata.py
./babbel_core/tests/test_orchestrator_fallback.py
./babbel_core/tests/test_culture_shift.py
./babbel_core/tests/test_session_controls.py
./babbel_core/tests/__init__.py
./babbel_core/tests/test_app_smoke.py
./babbel_core/tests/test_pipeline_smoke_extra.py
./babbel_core/tests/test_orchestrator.py
./babbel_core/tests/test_schema.py
./babbel_core/tests/test_export_script.py
./babbel_core/tests/test_hx_engine.py
./babbel_core/tests/test_memory_tracker.py
./babbel_core/tests/test_self_awareness.py
./babbel_core/tests/test_scanners.py
./babbel_core/tests/test_thread_index_ops.py
./babbel_core/tests/test_pipeline_output.py
./babbel_core/tests/test_pipeline.py
./babbel_core/tests/test_orchestrator_ux.py
./babbel_core/tests/test_review.py
./babbel_core/protocol_engine.py
./babbel_core/self_awareness.py
./babbel_core/__init__.py
./babbel_core/memory_tracker.py
./babbel_core/review.py
./babbel_core/test_pipeline_run.py
./babbel_core/_quarantine_manual
./babbel_core/_quarantine_manual/review.py
./babbel_core/_quarantine_manual/schema_validation.py
./babbel_core/adapters
./babbel_core/adapters/__init__.py
./babbel_core/final_fix_patch.sh
./babbel_core/engine.py
./babbel_core/chat.py
./babbel_core/_auth_diag.py
./babbel_core/utils.py
./babbel_core/pipeline.py
./babbel_core/session_controls.py
./babbel_core/scripts
./babbel_core/scripts/preflight.sh
./babbel_core/scripts/export_history_csv.py
./babbel_core/ci_failure_log.txt
./babbel_core/identity_lock.py
./babbel_core/orchestrator 2.py
./babbel_core/__init__ 2.py
./babbel_core/tone_classifier.py
./babbel_core/find_dupes.sh
./babbel_core/show_ci_log.sh
./babbel_core/save_ci_log.sh
./babbel_core/node_classifier.py
./babbel_core/conversations.py
./babbel_core/session_controller.py
./Babbel_Streamlit_Complete
./Babbel_Streamlit_Complete/constraints.txt
./Babbel_Streamlit_Complete/.DS_Store
./Babbel_Streamlit_Complete/node_response_rules.json
./Babbel_Streamlit_Complete/speech_protocols.json
./Babbel_Streamlit_Complete/BRANCH_PROTECTION.txt
./Babbel_Streamlit_Complete/Makefile
./Babbel_Streamlit_Complete/project_structure.txt
./Babbel_Streamlit_Complete/README.md
./Babbel_Streamlit_Complete/run_tests.sh
./_chat_probe.json
./.DS_Store
./node_response_rules.json
./core
./core/.DS_Store
./core/__pycache__
./core/__pycache__/pipeline.cpython-311.pyc
./core/__pycache__/__init__.cpython-311.pyc
./speech_protocols.json
./pytest.ini
./requirements.txt
./.pytest_cache
./.pytest_cache/CACHEDIR.TAG
./.pytest_cache/README.md
./.pytest_cache/.gitignore
./.pytest_cache/v
./.pytest_cache/v/cache
./fix_babbel_core.sh
./memory_log.json
./Makefile
./.streamlit
./.streamlit/config.toml
./fix_test_failures.sh
./fix_engine_and_pipeline_imports.sh
./repair_babbel_all.sh
./fix_git_sync.sh
./__pycache__
./__pycache__/pipeline.cpython-311.pyc
./__pycache__/utils.cpython-311.pyc
./__pycache__/session_controls.cpython-311.pyc
./__pycache__/engine.cpython-311.pyc
./__pycache__/self_awareness.cpython-311.pyc
./babbel_core_upgrade_ultimate_fixed.sh
./patch_core_and_tests.sh
./duplicates_final.txt
./fix_babbel_all_real.sh
./sessions
./sessions/1755989319_test_session_start_fa61de.json
./sessions/1755989054_test_session_start_8605e5.json
./sessions/1755989243_test_session_start_e83a05.json
./sessions/1755989730_test_session_start_91ba04.json
./sessions/20250824-222551-export.csv
./sessions/1755989052_test_session_start_76e8d9.json
./sessions/1755989343_test_session_start_ce1940.json
./sessions/index.json
./sessions/1755989679_test_session_start_7023c5.json
./_or_probe_server.json
./duplicates_report.txt
./.gitignore
./run_app.sh
./events.jsonl
./run_tests.sh
./.venv
./.venv/bin
./.venv/bin/pip3.9
./.venv/bin/streamlit.cmd
./.venv/bin/jupyter-run
./.venv/bin/activate.csh.bak.20250824-195019
./.venv/bin/activate.fish.bak.20250824-195019
./.venv/bin/Activate.ps1
./.venv/bin/streamlit
./.venv/bin/python3
./.venv/bin/pytest
./.venv/bin/python
./.venv/bin/pip3
./.venv/bin/ipython
./.venv/bin/activate.fish
./.venv/bin/python3.9
./.venv/bin/jupyter-dejavu
./.venv/bin/f2py
./.venv/bin/ipython3
./.venv/bin/pip
./.venv/bin/httpx
./.venv/bin/jupyter-nbconvert
./.venv/bin/jsonschema
./.venv/bin/jupyter-troubleshoot
./.venv/bin/pygmentize
./.venv/bin/jupyter-migrate
./.venv/bin/pipreqs
./.venv/bin/activate.bak.20250824-195019
./.venv/bin/activate
./.venv/bin/normalizer
./.venv/bin/numpy-config
./.venv/bin/jupyter-trust
./.venv/bin/watchmedo
./.venv/bin/jupyter-kernelspec
./.venv/bin/jupyter-kernel
./.venv/bin/jupyter
./.venv/bin/py.test
./.venv/bin/jupyter-execute
./.venv/bin/activate.csh
./.venv/include
./.venv/etc
./.venv/etc/jupyter
./.venv/pyvenv.cfg
./.venv/lib
./.venv/lib/python3.9
./.venv/share
./.venv/share/man
./.venv/share/jupyter
./scripts
./scripts/fix_everything.sh
./scripts/git_pull_fresh.sh
./scripts/openrouter_env.sh
./scripts/python_nowarn.sh
./scripts/install.sh
./scripts/run_all.sh
./scripts/clean_env.sh
./scripts/git_sync.sh
./scripts/.keep
./scripts/git_setup.sh
./scripts/diagnostics.log
./scripts/run_all_tests.sh
./scripts/fix_test_runner.sh
./scripts/run_streamlit.sh
./scripts/fix_ci_errors.sh
./scripts/patch_headers.py
./scripts/deny_scan.sh
./scripts/gh_login.sh
./scripts/quick_start.sh
./scripts/openrouter_py_probe.py
./scripts/openrouter_auth_probe.sh
./scripts/restructure_package.sh
./scripts/fix_imports.sh
./.github
./.github/workflows
./.github/workflows/policy_weekly.yml
./.github/workflows/policy_nightly.yml
./.github/workflows/ci.yml
./ci_failure_log.txt
./fix_pipeline_imports.sh
./file_structure.txt
./.git
./.git/ORIG_HEAD
./.git/config
./.git/objects
./.git/objects/61
./.git/objects/0d
./.git/objects/95
./.git/objects/59
./.git/objects/92
./.git/objects/0c
./.git/objects/66
./.git/objects/3e
./.git/objects/68
./.git/objects/57
./.git/objects/3b
./.git/objects/6f
./.git/objects/03
./.git/objects/9e
./.git/objects/32
./.git/objects/35
./.git/objects/69
./.git/objects/3c
./.git/objects/51
./.git/objects/3d
./.git/objects/58
./.git/objects/67
./.git/objects/0b
./.git/objects/93
./.git/objects/94
./.git/objects/0e
./.git/objects/60
./.git/objects/34
./.git/objects/5a
./.git/objects/5f
./.git/objects/05
./.git/objects/9d
./.git/objects/9c
./.git/objects/02
./.git/objects/a4
./.git/objects/a3
./.git/objects/b5
./.git/objects/b2
./.git/objects/d9
./.git/objects/ac
./.git/objects/ad
./.git/objects/bb
./.git/objects/d0
./.git/objects/be
./.git/objects/b3
./.git/objects/df
./.git/objects/da
./.git/objects/b4
./.git/objects/a2
./.git/objects/bd
./.git/objects/d1
./.git/objects/bc
./.git/objects/ae
./.git/objects/d8
./.git/objects/e5
./.git/objects/f3
./.git/objects/eb
./.git/objects/c7
./.git/objects/ee
./.git/objects/c9
./.git/objects/fc
./.git/objects/f2
./.git/objects/f5
./.git/objects/e3
./.git/objects/cf
./.git/objects/e4
./.git/objects/fe
./.git/objects/c8
./.git/objects/fb
./.git/objects/ed
./.git/objects/c1
./.git/objects/c6
./.git/objects/ec
./.git/objects/4e
./.git/objects/20
./.git/objects/18
./.git/objects/27
./.git/objects/4b
./.git/objects/pack
./.git/objects/11
./.git/objects/7d
./.git/objects/29
./.git/objects/7c
./.git/objects/16
./.git/objects/89
./.git/objects/45
./.git/objects/1f
./.git/objects/73
./.git/objects/87
./.git/objects/74
./.git/objects/1a
./.git/objects/28
./.git/objects/8f
./.git/objects/8a
./.git/objects/7e
./.git/objects/10
./.git/objects/19
./.git/objects/4c
./.git/objects/26
./.git/objects/21
./.git/objects/4d
./.git/objects/75
./.git/objects/81
./.git/objects/86
./.git/objects/72
./.git/objects/2a
./.git/objects/2f
./.git/objects/43
./.git/objects/88
./.git/objects/9f
./.git/objects/6b
./.git/objects/07
./.git/objects/00
./.git/objects/6e
./.git/objects/9a
./.git/objects/36
./.git/objects/5c
./.git/objects/09
./.git/objects/5d
./.git/objects/31
./.git/objects/info
./.git/objects/65
./.git/objects/96
./.git/objects/3a
./.git/objects/54
./.git/objects/98
./.git/objects/30
./.git/objects/5e
./.git/objects/5b
./.git/objects/37
./.git/objects/08
./.git/objects/01
./.git/objects/06
./.git/objects/6c
./.git/objects/39
./.git/objects/55
./.git/objects/97
./.git/objects/63
./.git/objects/0f
./.git/objects/0a
./.git/objects/64
./.git/objects/90
./.git/objects/bf
./.git/objects/d4
./.git/objects/ba
./.git/objects/a0
./.git/objects/b8
./.git/objects/b1
./.git/objects/dd
./.git/objects/dc
./.git/objects/b6
./.git/objects/a9
./.git/objects/d5
./.git/objects/aa
./.git/objects/af
./.git/objects/b7
./.git/objects/db
./.git/objects/a8
./.git/objects/de
./.git/objects/b0
./.git/objects/a6
./.git/objects/b9
./.git/objects/a1
./.git/objects/ef
./.git/objects/c3
./.git/objects/c4
./.git/objects/ea
./.git/objects/e1
./.git/objects/e6
./.git/objects/f9
./.git/objects/f0
./.git/objects/f7
./.git/objects/e8
./.git/objects/fa
./.git/objects/ff
./.git/objects/c5
./.git/objects/c2
./.git/objects/f6
./.git/objects/e9
./.git/objects/f1
./.git/objects/e7
./.git/objects/cb
./.git/objects/f8
./.git/objects/e0
./.git/objects/46
./.git/objects/2c
./.git/objects/79
./.git/objects/41
./.git/objects/83
./.git/objects/1b
./.git/objects/48
./.git/objects/70
./.git/objects/1e
./.git/objects/84
./.git/objects/4a
./.git/objects/24
./.git/objects/23
./.git/objects/4f
./.git/objects/8d
./.git/objects/15
./.git/objects/8c
./.git/objects/85
./.git/objects/1d
./.git/objects/76
./.git/objects/82
./.git/objects/49
./.git/objects/40
./.git/objects/2e
./.git/objects/2b
./.git/objects/47
./.git/objects/78
./.git/objects/13
./.git/objects/7f
./.git/objects/14
./.git/objects/8e
./.git/objects/22
./.git/.COMMIT_EDITMSG.swp
./.git/HEAD
./.git/info
./.git/info/exclude
./.git/logs
./.git/logs/HEAD
./.git/logs/refs
./.git/description
./.git/hooks
./.git/hooks/commit-msg.sample
./.git/hooks/pre-rebase.sample
./.git/hooks/sendemail-validate.sample
./.git/hooks/pre-commit.sample
./.git/hooks/applypatch-msg.sample
./.git/hooks/fsmonitor-watchman.sample
./.git/hooks/pre-receive.sample
./.git/hooks/prepare-commit-msg.sample
./.git/hooks/post-update.sample
./.git/hooks/pre-merge-commit.sample
./.git/hooks/pre-applypatch.sample
./.git/hooks/pre-push.sample
./.git/hooks/update.sample
./.git/hooks/push-to-checkout.sample
./.git/refs
./.git/refs/heads
./.git/refs/tags
./.git/refs/remotes
./.git/index
./.git/packed-refs
./.git/COMMIT_EDITMSG
./.git/FETCH_HEAD
./save_ci_log.sh
./fix_pipeline_and_tests.sh
./backups
./backups/streamlit_babbel_app.py.20250824-194525
./backups/streamlit_babbel_app.py.20250824-200114
./backups/streamlit_babbel_app.py.20250824-194826
./backups/chat.py.20250824-200114
./backups/chat.py.20250824-194525
./remove_schema_validation.sh
./reports
./reports/snapshot_20250823_184411.tgz
./reports/key_scan.json

=== ENV (OPENROUTER*, PYTHONWARNINGS) ===
NO_PROXY=localhost,127.0.0.1
OPENROUTER_API_KEY=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
OPENROUTER_APP_TITLE=Babbel Official Dev
OPENROUTER_SITE_URL=http://localhost:8501

=== [requests] A) localhost (Referer+Origin) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084526-6wFADYYeWG36vYSdJQVv",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084528,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üòä How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 11,
    "total_tokens": 19,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [httpx] B) localhost (Referer+Origin) ===
--- Intended Headers ---
{
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084529-n2ZVEcHQnHBlqHfyDJre",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084530,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] C) 127.0.0.1 (Referer+Origin) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://127.0.0.1:8501",
  "Origin": "http://127.0.0.1:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084531-z1HnqZkg5EWecFywaWGB",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084533,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] D) Streamlit-expected ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084533-WrxKbW2SXgpeOeohp6JC",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084535,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] E) localhost (no X-Title) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084535-PKzORl5iSyRQ11lbWbuF",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084537,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] F) no Referer/Origin ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084537-lggnh8oM3L111vosyTd4",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084539,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

{
  "patch_results": [
    {
      "path": "babbel_core/streamlit_babbel_app.py",
      "exists": true,
      "changed": false
    },
    {
      "path": "babbel_core/chat.py",
      "exists": true,
      "changed": false
    }
  ]
}
=== Grep Referer/Origin/X-Title after patch ===
18:    if include_xtitle: h["X-Title"] = APP_TITLE
20:        h["HTTP-Referer"] = referer
21:        h["Referer"] = referer
22:    if origin: h["Origin"] = origin
31:    req = requests.Request("POST", API_URL, headers=build_headers(referer, origin, include_xtitle), json=payload)
33:    dbg_headers = {k: ("***" if k.lower()=="authorization" else v) for k,v in prepped.headers.items()}
42:    headers = build_headers(referer, origin, include_xtitle)
44:        r = c.post(API_URL, headers=headers, json=payload)
51:    headers = [
58:        "X-Title": APP_TITLE,
59:        "HTTP-Referer": SITE_URL,
60:        "Referer": SITE_URL,
61:        "Origin": SITE_URL,
68:    headers = _build_headers()
75:    resp = requests.post(OPENROUTER_URL, headers=headers, json=payload, timeout=90)

=== [requests] A) localhost (Referer+Origin) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084792-DR2xwhTo1B5g319e3x5Z",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084794,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [httpx] B) localhost (Referer+Origin) ===
--- Intended Headers ---
{
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084795-xfGrrH6jJpGrGnmsUAQW",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084796,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] C) 127.0.0.1 (Referer+Origin) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://127.0.0.1:8501",
  "Origin": "http://127.0.0.1:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084797-RVtszoQcIEanRdsyne1E",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084798,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] D) Streamlit-expected ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084799-oPQalBdyZxFRzkKxLnKq",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084800,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üòä How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 11,
    "total_tokens": 19,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] E) localhost (no X-Title) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084801-ck84x9Lj0BIwdUz1rvq7",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084802,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] F) no Referer/Origin ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084803-8bKFjyIMrxwM0NY6ywg5",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084805,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

{
  "patch_results": [
    {
      "path": "babbel_core/streamlit_babbel_app.py",
      "exists": true,
      "changed": false
    },
    {
      "path": "babbel_core/chat.py",
      "exists": true,
      "changed": false
    }
  ]
}
=== Grep Referer/Origin/X-Title after patch ===
18:    if include_xtitle: h["X-Title"] = APP_TITLE
20:        h["HTTP-Referer"] = referer
21:        h["Referer"] = referer
22:    if origin: h["Origin"] = origin
31:    req = requests.Request("POST", API_URL, headers=build_headers(referer, origin, include_xtitle), json=payload)
33:    dbg_headers = {k: ("***" if k.lower()=="authorization" else v) for k,v in prepped.headers.items()}
42:    headers = build_headers(referer, origin, include_xtitle)
44:        r = c.post(API_URL, headers=headers, json=payload)
51:    headers = [
58:        "X-Title": APP_TITLE,
59:        "HTTP-Referer": SITE_URL,
60:        "Referer": SITE_URL,
61:        "Origin": SITE_URL,
68:    headers = _build_headers()
75:    resp = requests.post(OPENROUTER_URL, headers=headers, json=payload, timeout=90)

=== [requests] A) localhost (Referer+Origin) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084890-qn7or94VEvJ3m85vo0t4",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084891,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üòä How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 11,
    "total_tokens": 19,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [httpx] B) localhost (Referer+Origin) ===
--- Intended Headers ---
{
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084892-Mp9AFh4jrXUQs5J0w5wr",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084893,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üòä How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 11,
    "total_tokens": 19,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] C) 127.0.0.1 (Referer+Origin) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://127.0.0.1:8501",
  "Origin": "http://127.0.0.1:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084894-AaNCWt15wMASk6BG9ulW",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084895,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üòä How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 11,
    "total_tokens": 19,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] D) Streamlit-expected ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084896-Yv0xcN3qZGsyylhMh4Mn",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084898,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] E) localhost (no X-Title) ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "Referer": "http://localhost:8501",
  "Origin": "http://localhost:8501",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084898-fWK9Yl2QBJ54kUvwva00",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084900,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üèì How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 13,
    "total_tokens": 21,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

=== [requests] F) no Referer/Origin ===
--- Prepared Headers ---
{
  "User-Agent": "python-requests/2.32.5",
  "Accept-Encoding": "gzip, deflate",
  "Accept": "*/*",
  "Connection": "keep-alive",
  "Authorization": "Bearer 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",
  "Content-Type": "application/json",
  "X-Title": "Babbel Official Dev",
  "Content-Length": "99"
}
--- Status ---
200
--- JSON (truncated) ---
{
  "id": "gen-1756084901-km8EvF4fgXwc4QubPVYu",
  "provider": "OpenAI",
  "model": "openai/chatgpt-4o-latest",
  "object": "chat.completion",
  "created": 1756084902,
  "choices": [
    {
      "logprobs": null,
      "finish_reason": "stop",
      "native_finish_reason": "stop",
      "index": 0,
      "message": {
        "role": "assistant",
        "content": "Pong! üòä How can I help you today?",
        "refusal": null,
        "reasoning": null
      }
    }
  ],
  "system_fingerprint": "fp_736be7fece",
  "usage": {
    "prompt_tokens": 8,
    "completion_tokens": 11,
    "total_tokens": 19,
    "prompt_tokens_details": {
      "cached_tokens": 0,
      "audio_tokens": 0
    },
    "completion_tokens_details": {
      "reasoning_tokens": 0
    }
  }
}

